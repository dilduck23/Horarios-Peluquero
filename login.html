<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | StaffPlanner</title>

    <!-- Tailwind & Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
        }

        /* Secure text for PIN */
        .secure-text {
            -webkit-text-security: disc;
            text-security: disc;
            font-family: text-security-disc;
        }

        /* Card animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20%,
            60% {
                transform: translateX(-10px);
            }

            40%,
            80% {
                transform: translateX(10px);
            }
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>

<body class="flex items-center justify-center p-6">

    <!-- SUPABASE CLIENT -->
    <script>
        const SUPABASE_URL = 'https://cectqtufttubsepyiolr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Ow2zQpNDPsLA6on9VBWFgg_Q0_LAc1D';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>

    <!-- LOGIN CARD -->
    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center animate-fadeInUp" id="loginCard">
        <div
            class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 text-4xl shadow-lg">
            ðŸ”’
        </div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">StaffPlanner</h2>
        <p class="text-slate-500 mb-6 text-sm">Ingresa tus credenciales para acceder</p>

        <!-- EMAIL LOGIN FORM -->
        <div id="loginFormEmail">
            <form onsubmit="event.preventDefault(); handleLogin()">
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Usuario</label>
                        <input type="text" id="loginUser"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 mt-1 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                            placeholder="admin@ejemplo.com">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">ContraseÃ±a</label>
                        <input type="password" id="loginPass"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 mt-1 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <!-- Cloudflare Turnstile Verification -->
                    <div class="mt-4">
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">VerificaciÃ³n de
                            seguridad</label>
                        <div class="cf-turnstile" data-sitekey="0x4AAAAAACNiFAenJVhU1FaV" data-theme="light"
                            data-language="es"></div>
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 rounded-xl mt-6 shadow-lg transition-all active:scale-[0.98]">
                    Entrar
                </button>

                <div class="mt-4 border-t pt-4">
                    <button type="button" onclick="toggleLoginMode('pin')"
                        class="w-full bg-slate-900 text-white py-3 rounded-xl text-sm font-bold shadow-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
                        <span>ðŸ”¢</span> Entrar con PIN
                    </button>
                </div>
            </form>
        </div>

        <!-- PIN LOGIN FORM (Hidden) -->
        <div id="loginFormPin" class="hidden">
            <h3 class="text-lg font-bold mb-4 text-slate-700">Ingreso Staff</h3>
            <p class="text-xs text-slate-400 mb-4">Ingresa tu ID de Vendedor</p>

            <input type="text" id="loginPin"
                class="secure-text w-full text-center text-4xl tracking-[0.5em] font-mono bg-slate-100 p-4 rounded-2xl border-2 border-slate-200 focus:border-blue-500 focus:ring-0 outline-none transition-colors"
                placeholder="â€¢â€¢â€¢â€¢" maxlength="4" inputmode="numeric" autocomplete="off" name="pin-entry-field">

            <button onclick="handlePinLogin()"
                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3 rounded-xl mt-6 shadow-lg hover:from-blue-700 hover:to-blue-800 transition-all active:scale-[0.98]">
                VALIDAR PIN
            </button>

            <button onclick="toggleLoginMode('email')"
                class="w-full text-slate-400 text-xs mt-6 hover:text-slate-600 underline">
                Volver a Login Email
            </button>
        </div>

        <p id="loginError" class="text-red-500 text-sm mt-4 hidden font-bold"></p>
    </div>

    <!-- JAVASCRIPT LOGIN LOGIC -->
    <script>
        // Check if already logged in
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('staffPlannerAuth') === 'true') {
                const roleId = parseInt(sessionStorage.getItem('staffPlannerRoleId') || '0');
                if (roleId === 4) {
                    window.location.href = 'mi-horario.html';
                } else {
                    window.location.href = 'index.html';
                }
            }
        });

        function toggleLoginMode(mode) {
            const emailForm = document.getElementById('loginFormEmail');
            const pinForm = document.getElementById('loginFormPin');
            const errorMsg = document.getElementById('loginError');
            errorMsg.classList.add('hidden');

            if (mode === 'pin') {
                emailForm.classList.add('hidden');
                pinForm.classList.remove('hidden');
                setTimeout(() => document.getElementById('loginPin').focus(), 100);
            } else {
                pinForm.classList.add('hidden');
                emailForm.classList.remove('hidden');
            }
        }

        async function handlePinLogin() {
            const pin = document.getElementById('loginPin').value.trim();
            const errorMsg = document.getElementById('loginError');
            errorMsg.classList.add('hidden');

            if (!pin || pin.length !== 4) {
                errorMsg.textContent = 'Ingresa un PIN de 4 dÃ­gitos';
                errorMsg.classList.remove('hidden');
                return;
            }

            try {
                // First, try to find in Impulsadoras
                let { data: impulsadora } = await db
                    .from('Tiendas_Impulsadoras')
                    .select('*')
                    .eq('pin', pin)
                    .single();

                // If not found, try Personal Interno
                let { data: personal } = await db
                    .from('Tiendas_Personal')
                    .select('*')
                    .eq('pin', pin)
                    .single();

                const staffUser = impulsadora || personal;
                const isPersonal = !impulsadora && !!personal;

                if (!staffUser) throw new Error('PIN no encontrado');

                // Success - Store session data
                sessionStorage.setItem('staffPlannerAuth', 'true');
                sessionStorage.setItem('staffPlannerRole', isPersonal ? 'personal' : 'staff');
                sessionStorage.setItem('staffPlannerStaffId', staffUser.id);
                sessionStorage.setItem('staffPlannerIsAdmin', 'false');
                sessionStorage.setItem('staffPlannerRoleId', '4');
                sessionStorage.setItem('staffPlannerRoleName', isPersonal ? 'Personal Interno' : 'Impulsadora');
                sessionStorage.setItem('staffPlannerUser', JSON.stringify({ email: staffUser.nombre_completo }));

                // Redirect based on user type and device
                const card = document.getElementById('loginCard');
                card.style.opacity = '0';
                card.style.transition = 'opacity 0.4s ease';

                setTimeout(() => {
                    if (isPersonal) {
                        window.location.href = 'personal.html';
                    } else {
                        // Check if mobile device for impulsadoras
                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
                        if (isMobile) {
                            window.location.href = 'mi-horario.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    }
                }, 400);

            } catch (err) {
                console.error('PIN Login error:', err);
                errorMsg.textContent = 'PIN InvÃ¡lido';
                errorMsg.classList.remove('hidden');

                const card = document.getElementById('loginCard');
                card.classList.add('animate-shake');
                setTimeout(() => card.classList.remove('animate-shake'), 500);
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            const errorMsg = document.getElementById('loginError');

            // Clear previous errors
            errorMsg.classList.add('hidden');

            // Validate Turnstile (Skip on localhost/file)
            const isLocal = ['localhost', '127.0.0.1', ''].includes(window.location.hostname) || window.location.protocol === 'file:';

            const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
            // Only require Turnstile if NOT local
            if (!isLocal && (!turnstileResponse || !turnstileResponse.value)) {
                errorMsg.textContent = 'Por favor, completa la verificaciÃ³n de seguridad';
                errorMsg.classList.remove('hidden');
                return;
            }

            try {
                const { data, error } = await db.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                // SUCCESS - Now fetch user role from database
                const userEmail = data.user.email;

                // Query Tiendas_Usuarios for role
                const { data: userData, error: userError } = await db
                    .from('Tiendas_Usuarios')
                    .select('*, Tiendas_Roles(*)')
                    .eq('email', userEmail)
                    .eq('activo', true)
                    .single();

                if (userError || !userData) {
                    throw new Error('Usuario no autorizado. Contacta al administrador.');
                }

                // Get role info
                const roleId = userData.id_rol;
                const roleName = userData.Tiendas_Roles?.nombre || 'Desconocido';

                // Store session data
                sessionStorage.setItem('staffPlannerAuth', 'true');
                sessionStorage.setItem('staffPlannerUser', JSON.stringify(data.user));
                sessionStorage.setItem('staffPlannerRoleId', roleId.toString());
                sessionStorage.setItem('staffPlannerRoleName', roleName);
                sessionStorage.setItem('staffPlannerUserId', userData.id.toString());

                // Legacy compatibility
                sessionStorage.setItem('staffPlannerIsAdmin', roleId === 1 ? 'true' : 'false');

                // Store tienda for PdV role
                if (userData.id_tienda) {
                    sessionStorage.setItem('staffPlannerTiendaId', userData.id_tienda.toString());
                }

                // Store impulsadora link if exists
                if (userData.id_impulsadora) {
                    sessionStorage.setItem('staffPlannerStaffId', userData.id_impulsadora.toString());
                }

                // Animation and redirect
                const card = document.getElementById('loginCard');
                card.style.opacity = '0';
                card.style.transition = 'opacity 0.4s ease';

                setTimeout(() => {
                    // Check if mobile device for admin/organizador/pdv
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
                    if (isMobile && roleId >= 1 && roleId <= 3) {
                        window.location.href = 'admin-mobile.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }, 400);

            } catch (err) {
                console.error('Login error:', err);
                errorMsg.textContent = 'Error: ' + (err.message || 'Credenciales invÃ¡lidas');
                errorMsg.classList.remove('hidden');

                const card = document.getElementById('loginCard');
                card.classList.add('animate-shake');
                setTimeout(() => card.classList.remove('animate-shake'), 500);
            }
        }

        // Auto-submit PIN on 4 digits
        document.addEventListener('DOMContentLoaded', () => {
            const pinInput = document.getElementById('loginPin');
            pinInput.addEventListener('input', (e) => {
                // Only allow numbers
                e.target.value = e.target.value.replace(/[^0-9]/g, '');

                if (e.target.value.length === 4) {
                    handlePinLogin();
                }
            });
        });
    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Horario | StaffPlanner</title>

    <!-- Tailwind & Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            overscroll-behavior: none;
        }

        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 2px;
        }

        /* Day card animations */
        .day-card {
            transition: all 0.2s ease;
        }

        .day-card:active {
            transform: scale(0.98);
        }

        /* Month selector */
        .month-pill {
            transition: all 0.2s ease;
        }

        .month-pill.active {
            background: white;
            color: #1e293b;
            font-weight: 700;
        }

        /* Store filter chip */
        .store-chip {
            transition: all 0.2s ease;
        }

        .store-chip.active {
            ring: 2px;
            ring-offset: 2px;
        }

        /* Store badge colors */
        .store-badge {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Loading skeleton */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Today indicator */
        .today-indicator {
            position: relative;
        }

        .today-indicator::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: #3b82f6;
            border-radius: 4px;
        }

        /* Secure text for PIN */
        .secure-text {
            -webkit-text-security: disc;
            text-security: disc;
            font-family: text-security-disc;
        }

        /* Hide scrollbar but keep scroll functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Light text helper for dark backgrounds */
        .text-light {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="text-white">

    <!-- SUPABASE CLIENT -->
    <script>
        const SUPABASE_URL = 'https://cectqtufttubsepyiolr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Ow2zQpNDPsLA6on9VBWFgg_Q0_LAc1D';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[99999] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center" id="loginCard">
            <div
                class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 text-4xl shadow-lg">
                ðŸ“…
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Mi Horario</h2>
            <p class="text-slate-500 mb-8 text-sm">Ingresa tu PIN para ver tu calendario</p>

            <input type="text" id="loginPin"
                class="secure-text w-full text-center text-4xl tracking-[0.5em] font-mono bg-slate-100 p-4 rounded-2xl border-2 border-slate-200 focus:border-blue-500 focus:ring-0 outline-none transition-colors"
                placeholder="â€¢â€¢â€¢â€¢" maxlength="4" inputmode="numeric" autocomplete="off">

            <button onclick="app.handlePinLogin()"
                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-4 rounded-2xl mt-6 shadow-lg hover:shadow-xl transition-all active:scale-[0.98]">
                INGRESAR
            </button>

            <p id="loginError" class="text-red-500 text-sm mt-4 hidden font-medium"></p>

            <a href="index.html" class="block mt-6 text-slate-400 text-xs hover:text-slate-600 underline">
                Acceso Administrador
            </a>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden min-h-screen flex flex-col">

        <!-- Header -->
        <header class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur-lg border-b border-slate-800 px-4 py-3">
            <!-- User Info -->
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div id="userAvatar"
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm shadow-lg">
                        --
                    </div>
                    <div>
                        <h1 id="userName" class="font-bold text-base text-white">Cargando...</h1>
                        <p id="userCategory" class="text-[10px] text-slate-400">â€¢ CategorÃ­a</p>
                    </div>
                </div>
                <button onclick="app.logout()"
                    class="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-xl transition-colors">
                    <span class="material-icons text-red-400 text-xl">logout</span>
                </button>
            </div>

            <!-- Store Filter (Horizontal Scroll) -->
            <div id="storeFilters" class="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4 hide-scrollbar">
                <button onclick="app.setStoreFilter(null)" id="filter-all"
                    class="store-chip flex-shrink-0 py-2 px-4 rounded-full text-xs font-semibold transition-all bg-white text-slate-900">
                    Todas
                </button>
                <!-- Store chips will be injected here -->
            </div>

            <!-- Month Selector -->
            <div class="flex items-center justify-center gap-2 mt-2">
                <button onclick="app.changeMonth(-1)" class="p-1.5 hover:bg-slate-800 rounded-lg transition-colors">
                    <span class="material-icons text-slate-400 text-lg">chevron_left</span>
                </button>

                <div class="flex gap-1 bg-slate-800/50 rounded-xl p-0.5">
                    <button onclick="app.goToMonth(-1)" id="month-prev"
                        class="month-pill px-3 py-1.5 rounded-lg text-xs text-slate-400">
                        NOV
                    </button>
                    <button onclick="app.goToMonth(0)" id="month-current"
                        class="month-pill active px-3 py-1.5 rounded-lg text-xs">
                        DIC
                    </button>
                    <button onclick="app.goToMonth(1)" id="month-next"
                        class="month-pill px-3 py-1.5 rounded-lg text-xs text-slate-400">
                        ENE
                    </button>
                </div>

                <button onclick="app.changeMonth(1)" class="p-1.5 hover:bg-slate-800 rounded-lg transition-colors">
                    <span class="material-icons text-slate-400 text-lg">chevron_right</span>
                </button>
            </div>
        </header>

        <!-- Calendar List -->
        <main id="calendarList" class="flex-1 overflow-y-auto custom-scroll px-4 py-3 space-y-2">
            <!-- Loading Skeletons -->
            <div class="skeleton h-16 rounded-xl"></div>
            <div class="skeleton h-16 rounded-xl"></div>
            <div class="skeleton h-16 rounded-xl"></div>
        </main>

        <!-- Footer Stats -->
        <footer class="bg-slate-900/95 backdrop-blur-lg border-t border-slate-800 px-4 py-3">
            <div class="flex justify-around text-center">
                <div>
                    <div id="statDaysWorked" class="text-xl font-bold text-blue-400">0</div>
                    <div class="text-[9px] text-slate-500 uppercase font-semibold">Asignados</div>
                </div>
                <div>
                    <div id="statDaysFree" class="text-xl font-bold text-amber-400">0</div>
                    <div class="text-[9px] text-slate-500 uppercase font-semibold">Libres</div>
                </div>
                <div>
                    <div id="statStores" class="text-xl font-bold text-purple-400">0</div>
                    <div class="text-[9px] text-slate-500 uppercase font-semibold">Tiendas</div>
                </div>
            </div>
        </footer>
    </div>

    <!-- JAVASCRIPT APP LOGIC -->
    <script>
        const app = {
            state: {
                currentDate: new Date(),
                personId: null,
                person: null,
                storeFilter: null, // null = all stores, or store ID
                data: {
                    tiendas: [],
                    personal: [],
                    categorias: [],
                    horarios: []
                }
            },

            // Day names in Spanish
            dayNames: ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado'],
            dayNamesShort: ['DOM', 'LUN', 'MAR', 'MIÃ‰', 'JUE', 'VIE', 'SÃB'],
            monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            monthNamesShort: ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'],

            // Palette of pastel colors for day cards
            cardColors: [
                { bg: 'bg-purple-100', text: 'text-purple-900', border: 'border-purple-300' },
                { bg: 'bg-rose-100', text: 'text-rose-900', border: 'border-rose-300' },
                { bg: 'bg-teal-100', text: 'text-teal-900', border: 'border-teal-300' },
                { bg: 'bg-amber-100', text: 'text-amber-900', border: 'border-amber-300' },
                { bg: 'bg-blue-100', text: 'text-blue-900', border: 'border-blue-300' },
                { bg: 'bg-emerald-100', text: 'text-emerald-900', border: 'border-emerald-300' },
                { bg: 'bg-pink-100', text: 'text-pink-900', border: 'border-pink-300' },
                { bg: 'bg-cyan-100', text: 'text-cyan-900', border: 'border-cyan-300' },
            ],

            // Helper to determine if a color is light or dark
            isLightColor: (hexColor) => {
                if (!hexColor) return true;
                const hex = hexColor.replace('#', '');
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                return brightness > 155;
            },

            init: async () => {
                // Check if already logged in
                const isLoggedIn = sessionStorage.getItem('staffPlannerAuth');
                const staffId = sessionStorage.getItem('staffPlannerStaffId');
                const roleId = parseInt(sessionStorage.getItem('staffPlannerRoleId') || '0');

                if (isLoggedIn === 'true' && staffId && roleId === 4) {
                    app.state.personId = parseInt(staffId);
                    document.getElementById('loginOverlay').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    await app.loadData();
                } else {
                    // Clear and show login
                    sessionStorage.clear();
                    document.getElementById('loginPin').focus();
                }
            },

            handlePinLogin: async () => {
                const pin = document.getElementById('loginPin').value.trim();
                const errorMsg = document.getElementById('loginError');
                errorMsg.classList.add('hidden');

                if (!pin || pin.length !== 4) {
                    errorMsg.textContent = 'Ingresa un PIN de 4 dÃ­gitos';
                    errorMsg.classList.remove('hidden');
                    return;
                }

                try {
                    // Search in Impulsadoras
                    let { data: impulsadora } = await db
                        .from('Tiendas_Impulsadoras')
                        .select('*')
                        .eq('pin', pin)
                        .eq('Habilitado', true)
                        .single();

                    if (!impulsadora) throw new Error('PIN no encontrado');

                    // Store session
                    sessionStorage.setItem('staffPlannerAuth', 'true');
                    sessionStorage.setItem('staffPlannerRole', 'staff');
                    sessionStorage.setItem('staffPlannerStaffId', impulsadora.id);
                    sessionStorage.setItem('staffPlannerIsAdmin', 'false');
                    sessionStorage.setItem('staffPlannerRoleId', '4');
                    sessionStorage.setItem('staffPlannerRoleName', 'Impulsadora');
                    sessionStorage.setItem('staffPlannerUser', JSON.stringify({ email: impulsadora.nombre_completo }));

                    app.state.personId = impulsadora.id;

                    // Animate transition
                    const overlay = document.getElementById('loginOverlay');
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.4s ease';

                    setTimeout(async () => {
                        overlay.classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        await app.loadData();
                    }, 400);

                } catch (err) {
                    console.error('PIN Login error:', err);
                    errorMsg.textContent = 'PIN InvÃ¡lido o Usuario Deshabilitado';
                    errorMsg.classList.remove('hidden');

                    const card = document.getElementById('loginCard');
                    card.style.animation = 'shake 0.5s ease';
                    setTimeout(() => card.style.animation = '', 500);
                }
            },

            logout: () => {
                sessionStorage.clear();
                location.reload();
            },

            loadData: async () => {
                const [tiendasRes, personalRes, categoriasRes] = await Promise.all([
                    db.from('Tiendas_Razonamiento').select('*'),
                    db.from('Tiendas_Impulsadoras').select('*'),
                    db.from('Tiendas_Categorias').select('*')
                ]);

                app.state.data.tiendas = tiendasRes.data || [];
                app.state.data.personal = personalRes.data || [];
                app.state.data.categorias = categoriasRes.data || [];

                // Get current person
                app.state.person = app.state.data.personal.find(p => p.id === app.state.personId);

                await app.fetchAssignments();
                app.renderHeader();
                app.renderStoreFilters();
                app.renderCalendar();
                app.updateMonthSelector();
            },

            fetchAssignments: async () => {
                const year = app.state.currentDate.getFullYear();
                const month = app.state.currentDate.getMonth();
                const firstDay = new Date(year, month, 1).toISOString().split('T')[0];
                const lastDay = new Date(year, month + 1, 0).toISOString().split('T')[0];

                const { data, error } = await db
                    .from('Tiendas_Horario')
                    .select('*')
                    .eq('impulsadora_id', app.state.personId)
                    .gte('fecha', firstDay)
                    .lte('fecha', lastDay);

                if (error) console.error('Error fetching schedule', error);
                app.state.data.horarios = data || [];
            },

            renderHeader: () => {
                const person = app.state.person;
                if (!person) return;

                const category = app.state.data.categorias.find(c => c.id === person.idCategoria);
                const initials = person.nombre_completo.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

                document.getElementById('userAvatar').textContent = initials;
                document.getElementById('userName').textContent = person.nombre_completo;
                document.getElementById('userCategory').textContent = `â€¢ ${category?.descripcion || 'Sin categorÃ­a'} | ${person.Marca || ''}`;
            },

            renderStoreFilters: () => {
                // Get unique stores from assignments
                const storeIds = [...new Set(app.state.data.horarios.map(h => h.tienda_id))];
                const stores = storeIds.map(id => app.state.data.tiendas.find(t => t.id === id)).filter(Boolean);

                const container = document.getElementById('storeFilters');
                let html = `
                    <button onclick="app.setStoreFilter(null)" id="filter-all"
                        class="store-chip flex-shrink-0 py-2 px-4 rounded-full text-xs font-semibold transition-all ${app.state.storeFilter === null ? 'bg-white text-slate-900' : 'bg-slate-800 text-slate-400'}">
                        Todas
                    </button>
                `;

                stores.forEach(store => {
                    const isActive = app.state.storeFilter === store.id;
                    const storeColor = store.color_hex || '#6366f1';
                    html += `
                        <button onclick="app.setStoreFilter(${store.id})" 
                            class="store-chip flex-shrink-0 py-2 px-4 rounded-full text-xs font-semibold transition-all flex items-center gap-2 ${isActive ? 'ring-2 ring-white ring-offset-2 ring-offset-slate-900' : ''}"
                            style="background-color: ${storeColor}; color: white;">
                            ${store.nombre_display}
                        </button>
                    `;
                });

                container.innerHTML = html;
            },

            renderCalendar: () => {
                const year = app.state.currentDate.getFullYear();
                const month = app.state.currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                let html = '';
                let daysWorked = 0;
                let daysFree = 0;
                const storesVisited = new Set();

                // Only show days WITH assignments
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dateObj = new Date(year, month, d);
                    const dayOfWeek = dateObj.getDay();
                    const dayName = app.dayNames[dayOfWeek];
                    const isToday = dateStr === todayStr;
                    const assignment = app.state.data.horarios.find(a => a.fecha === dateStr);

                    // Only show days with assignments
                    if (!assignment) {
                        daysFree++;
                        continue;
                    }

                    // Store filter
                    if (app.state.storeFilter !== null && assignment.tienda_id !== app.state.storeFilter) {
                        continue;
                    }

                    daysWorked++;
                    const store = app.state.data.tiendas.find(t => t.id === assignment.tienda_id);
                    if (store) storesVisited.add(store.id);

                    // Use store color as card background
                    const storeColor = store?.color_hex || '#6366f1';
                    // Determine if we need light or dark text based on color brightness
                    const isLightColor = app.isLightColor(storeColor);
                    const textClass = isLightColor ? 'text-slate-800' : 'text-white text-light';
                    const dateTextClass = isLightColor ? 'text-slate-700' : 'text-white/90';
                    const dividerClass = isLightColor ? 'bg-black/10' : 'bg-white/20';

                    html += `
                    <div class="day-card rounded-xl p-3 flex items-center gap-3 ${isToday ? 'ring-2 ring-blue-500 ring-offset-2 ring-offset-slate-900' : ''}"
                         style="background-color: ${storeColor}">
                        <!-- Date Section - Compact -->
                        <div class="w-14 text-center flex-shrink-0 ${isToday ? 'today-indicator' : ''}">
                            <div class="text-[10px] font-semibold ${dateTextClass} opacity-70 uppercase">${app.dayNamesShort[dayOfWeek]}</div>
                            <div class="text-3xl font-extrabold ${dateTextClass} leading-none">${d}</div>
                            <div class="text-xs font-bold ${dateTextClass} opacity-60 uppercase">${app.monthNamesShort[month]}</div>
                        </div>
                        
                        <!-- Divider -->
                        <div class="w-px h-12 ${dividerClass}"></div>
                        
                        <!-- Store Name - Larger & Centered -->
                        <div class="flex-1 flex items-center min-w-0">
                            <div class="font-bold ${textClass} text-base leading-tight">${store?.nombre_display || 'Sin tienda'}</div>
                        </div>
                    </div>`;
                }

                if (!html) {
                    html = `
                    <div class="text-center py-10">
                        <span class="material-icons text-4xl text-slate-600 mb-2">event_busy</span>
                        <p class="text-slate-500 text-sm">No hay asignaciones este mes</p>
                    </div>`;
                }

                document.getElementById('calendarList').innerHTML = html;

                // Update stats
                document.getElementById('statDaysWorked').textContent = daysWorked;
                document.getElementById('statDaysFree').textContent = daysFree;
                document.getElementById('statStores').textContent = storesVisited.size;
            },

            updateMonthSelector: () => {
                const month = app.state.currentDate.getMonth();
                const prevMonth = month === 0 ? 11 : month - 1;
                const nextMonth = month === 11 ? 0 : month + 1;

                document.getElementById('month-prev').textContent = app.monthNamesShort[prevMonth];
                document.getElementById('month-current').textContent = app.monthNamesShort[month];
                document.getElementById('month-next').textContent = app.monthNamesShort[nextMonth];
            },

            changeMonth: async (delta) => {
                app.state.currentDate.setMonth(app.state.currentDate.getMonth() + delta);
                await app.fetchAssignments();
                app.renderStoreFilters();
                app.renderCalendar();
                app.updateMonthSelector();
            },

            goToMonth: async (delta) => {
                await app.changeMonth(delta);
            },

            setStoreFilter: (storeId) => {
                app.state.storeFilter = storeId;
                app.renderStoreFilters();
                app.renderCalendar();
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => app.init());

        // Auto-submit PIN on 4 digits
        document.addEventListener('DOMContentLoaded', () => {
            const pinInput = document.getElementById('loginPin');
            pinInput.addEventListener('input', (e) => {
                // Only allow numbers
                e.target.value = e.target.value.replace(/[^0-9]/g, '');

                if (e.target.value.length === 4) {
                    app.handlePinLogin();
                }
            });
        });
    </script>

</body>

</html>
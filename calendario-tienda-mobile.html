<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tiendas | StaffPlanner</title>

    <!-- Tailwind & Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            overscroll-behavior: none;
        }

        /* Hide scrollbar */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Day pill active state */
        .day-pill {
            transition: all 0.2s ease;
        }

        .day-pill.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        /* Filter pill active */
        .filter-pill {
            transition: all 0.2s ease;
        }

        .filter-pill.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        /* Card animations */
        .staff-card {
            transition: all 0.2s ease;
        }

        .staff-card:active {
            transform: scale(0.98);
        }

        /* Navbar active */
        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item.active {
            color: #f59e0b;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        /* Loading skeleton */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>

<body class="text-slate-800 pb-20">

    <!-- SUPABASE CLIENT -->
    <script>
        const SUPABASE_URL = 'https://cectqtufttubsepyiolr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Ow2zQpNDPsLA6on9VBWFgg_Q0_LAc1D';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>

    <!-- MAIN APP -->
    <div id="mainApp" class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white border-b border-slate-100 px-4 py-3 shadow-sm">
            <!-- Store Selector Row -->
            <div class="flex items-center gap-2 mb-3">
                <span class="material-icons text-amber-500">storefront</span>
                <select id="storeSelect" onchange="app.onStoreChange()"
                    class="flex-1 bg-amber-50 border-2 border-amber-200 text-slate-800 text-sm font-bold rounded-xl px-3 py-2 focus:ring-2 focus:ring-amber-400 cursor-pointer">
                    <option value="">Seleccione una tienda...</option>
                </select>
            </div>

            <!-- Date Selector Row -->
            <div class="flex items-center justify-between mb-3">
                <button onclick="app.openDatePicker()"
                    class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 rounded-xl px-4 py-2 transition-colors">
                    <span class="material-icons text-slate-500 text-lg">calendar_today</span>
                    <span id="selectedDateText" class="font-semibold text-slate-700 text-sm">Dom, 19 Ene 2026</span>
                    <span class="material-icons text-slate-400 text-sm">expand_more</span>
                </button>
            </div>

            <!-- Day Pills -->
            <div id="dayPills" class="flex gap-2 overflow-x-auto hide-scrollbar -mx-4 px-4 pb-2">
                <!-- Injected by JS -->
            </div>

            <!-- Filter Pills -->
            <div class="flex gap-2 mb-2">
                <button onclick="app.setFilter('all')" id="filter-all"
                    class="filter-pill active flex-1 py-2 px-3 rounded-xl text-xs font-bold text-center bg-slate-100">
                    Ver Todos
                </button>
                <button onclick="app.setFilter('impulsadoras')" id="filter-impulsadoras"
                    class="filter-pill flex-1 py-2 px-3 rounded-xl text-xs font-bold text-center bg-slate-100 text-slate-600">
                    Impulsadoras
                </button>
                <button onclick="app.setFilter('personal')" id="filter-personal"
                    class="filter-pill flex-1 py-2 px-3 rounded-xl text-xs font-bold text-center bg-slate-100 text-slate-600">
                    Personal
                </button>
            </div>

            <!-- Search Input -->
            <div class="relative">
                <span
                    class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">search</span>
                <input type="text" id="searchInput" placeholder="Buscar por nombre..." oninput="app.onSearchChange()"
                    class="w-full pl-10 pr-4 py-2 bg-slate-100 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
            </div>
        </header>

        <!-- Assignments Count -->
        <div class="px-4 py-3 bg-white border-b border-slate-100">
            <h2 class="font-bold text-slate-800">
                Personal Asignado <span id="assignmentCount" class="text-amber-500">(0)</span>
            </h2>
        </div>

        <!-- Staff List -->
        <main id="staffList" class="flex-1 overflow-y-auto bg-slate-50">
            <!-- Loading Skeletons -->
            <div class="p-4 space-y-3">
                <div class="skeleton h-16 rounded-xl"></div>
                <div class="skeleton h-16 rounded-xl"></div>
                <div class="skeleton h-16 rounded-xl"></div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-4 py-2 z-50">
            <div class="flex justify-around items-center">
                <button onclick="app.switchTab('calendar')"
                    class="nav-item flex flex-col items-center gap-1 p-2 text-slate-400">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center">
                        <span class="material-icons">calendar_month</span>
                    </div>
                    <span class="text-[10px] font-semibold">Calendario</span>
                </button>
                <button onclick="app.switchTab('stores')" class="nav-item active flex flex-col items-center gap-1 p-2">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center">
                        <span class="material-icons">storefront</span>
                    </div>
                    <span class="text-[10px] font-semibold">Tiendas</span>
                </button>
                <button onclick="app.switchTab('staff')"
                    class="nav-item flex flex-col items-center gap-1 p-2 text-slate-400">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center">
                        <span class="material-icons">groups</span>
                    </div>
                    <span class="text-[10px] font-semibold">Staff</span>
                </button>
                <button onclick="app.switchTab('reports')"
                    class="nav-item flex flex-col items-center gap-1 p-2 text-slate-400">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center">
                        <span class="material-icons">assessment</span>
                    </div>
                    <span class="text-[10px] font-semibold">Reportes</span>
                </button>
                <button onclick="app.switchTab('profile')"
                    class="nav-item flex flex-col items-center gap-1 p-2 text-slate-400">
                    <div id="userNavAvatar"
                        class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center bg-slate-200 text-slate-600 font-bold text-sm">
                        U
                    </div>
                    <span class="text-[10px] font-semibold">Perfil</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- JAVASCRIPT APP LOGIC -->
    <script>
        const app = {
            state: {
                selectedDate: new Date(),
                selectedStoreId: null,
                viewFilter: 'all', // 'all', 'impulsadoras', 'personal'
                searchQuery: '',
                user: null,
                data: {
                    tiendas: [],
                    impulsadoras: [],
                    personal: [],
                    horarios: [],
                    personalHorarios: []
                }
            },

            dayNames: ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'],
            monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],

            isLightColor: (hexColor) => {
                if (!hexColor) return true;
                const hex = hexColor.replace('#', '');
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                return brightness > 155;
            },

            init: async () => {
                // Check auth
                if (sessionStorage.getItem('staffPlannerAuth') !== 'true') {
                    window.location.href = 'login.html';
                    return;
                }

                app.state.user = JSON.parse(sessionStorage.getItem('staffPlannerUser') || '{}');

                // Set user avatar
                const email = app.state.user.email || '';
                const initial = email.substring(0, 1).toUpperCase();
                document.getElementById('userNavAvatar').textContent = initial;

                await app.loadData();
            },

            loadData: async () => {
                try {
                    const [tiendasRes, impulsadorasRes, personalRes] = await Promise.all([
                        db.from('Tiendas_Razonamiento').select('*').order('nombre_display'),
                        db.from('Tiendas_Impulsadoras').select('*'),
                        db.from('Tiendas_Personal').select('*')
                    ]);

                    app.state.data.tiendas = (tiendasRes.data || []).filter(t => t.activo === true);
                    app.state.data.impulsadoras = impulsadorasRes.data || [];
                    app.state.data.personal = (personalRes.data || []).filter(p => p.habilitado === true);

                    app.populateStoreDropdown();
                    app.renderDayPills();
                    app.updateDateText();

                    // Auto-select user's store if linked
                    const userTiendaId = parseInt(sessionStorage.getItem('staffPlannerTiendaId') || '0');
                    if (userTiendaId && app.state.data.tiendas.find(t => t.id === userTiendaId)) {
                        document.getElementById('storeSelect').value = userTiendaId;
                        app.state.selectedStoreId = userTiendaId;
                        await app.fetchHorarios();
                        app.renderStaffList();
                    } else {
                        app.renderStaffList();
                    }

                } catch (err) {
                    console.error('Load error:', err);
                    Swal.fire('Error', err.message, 'error');
                }
            },

            populateStoreDropdown: () => {
                const select = document.getElementById('storeSelect');
                select.innerHTML = '<option value="">Seleccione una tienda...</option>';

                const userTiendaId = parseInt(sessionStorage.getItem('staffPlannerTiendaId') || '0');

                const sorted = [...app.state.data.tiendas].sort((a, b) => {
                    if (a.id === userTiendaId) return -1;
                    if (b.id === userTiendaId) return 1;
                    return (a.nombre_display || '').localeCompare(b.nombre_display || '');
                });

                sorted.forEach(store => {
                    const opt = document.createElement('option');
                    opt.value = store.id;
                    opt.textContent = store.nombre_display;
                    select.appendChild(opt);
                });
            },

            onStoreChange: async () => {
                app.state.selectedStoreId = parseInt(document.getElementById('storeSelect').value) || null;
                if (app.state.selectedStoreId) {
                    await app.fetchHorarios();
                }
                app.renderStaffList();
            },

            fetchHorarios: async () => {
                const dateStr = app.formatDate(app.state.selectedDate);

                const [horariosRes, personalHorariosRes] = await Promise.all([
                    db.from('Tiendas_Horario').select('*').eq('fecha', dateStr).eq('tienda_id', app.state.selectedStoreId),
                    db.from('Tiendas_Personal_Horario').select('*').eq('fecha', dateStr).eq('tienda_id', app.state.selectedStoreId)
                ]);

                app.state.data.horarios = horariosRes.data || [];
                app.state.data.personalHorarios = personalHorariosRes.data || [];
            },

            formatDate: (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            updateDateText: () => {
                const d = app.state.selectedDate;
                const dayName = app.dayNames[d.getDay()];
                const day = d.getDate();
                const month = app.monthNamesShort[d.getMonth()];
                const year = d.getFullYear();
                document.getElementById('selectedDateText').textContent = `${dayName}, ${day} ${month} ${year}`;
            },

            renderDayPills: () => {
                const today = new Date();
                const selectedStr = app.formatDate(app.state.selectedDate);
                let html = '';

                for (let i = -2; i <= 4; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    const dateStr = app.formatDate(date);
                    const isActive = dateStr === selectedStr;

                    html += `
                    <button onclick="app.selectDate('${dateStr}')" 
                        class="day-pill flex-shrink-0 flex flex-col items-center px-4 py-2 rounded-xl ${isActive ? 'active' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                        <span class="text-xs font-medium ${isActive ? 'text-white/80' : ''}">${app.dayNames[date.getDay()]}</span>
                        <span class="text-lg font-bold">${date.getDate()}</span>
                    </button>`;
                }

                document.getElementById('dayPills').innerHTML = html;
            },

            selectDate: async (dateStr) => {
                const [year, month, day] = dateStr.split('-').map(Number);
                app.state.selectedDate = new Date(year, month - 1, day);
                app.renderDayPills();
                app.updateDateText();

                if (app.state.selectedStoreId) {
                    await app.fetchHorarios();
                    app.renderStaffList();
                }
            },

            openDatePicker: () => {
                const currentDate = app.formatDate(app.state.selectedDate);

                Swal.fire({
                    title: 'Seleccionar Fecha',
                    html: `<input type="date" id="swal-date" class="w-full p-3 border border-slate-300 rounded-xl text-lg" value="${currentDate}">`,
                    showCancelButton: true,
                    confirmButtonText: 'Seleccionar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#f59e0b',
                    preConfirm: () => {
                        return document.getElementById('swal-date').value;
                    }
                }).then(async (result) => {
                    if (result.isConfirmed && result.value) {
                        await app.selectDate(result.value);
                    }
                });
            },

            setFilter: (filter) => {
                app.state.viewFilter = filter;

                // Update UI
                ['all', 'impulsadoras', 'personal'].forEach(f => {
                    const btn = document.getElementById(`filter-${f}`);
                    if (f === filter) {
                        btn.classList.add('active');
                        btn.classList.remove('text-slate-600');
                    } else {
                        btn.classList.remove('active');
                        btn.classList.add('text-slate-600');
                    }
                });

                app.renderStaffList();
            },

            onSearchChange: () => {
                app.state.searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
                app.renderStaffList();
            },

            renderStaffList: () => {
                const container = document.getElementById('staffList');

                if (!app.state.selectedStoreId) {
                    container.innerHTML = `
                        <div class="text-center py-16">
                            <span class="material-icons text-5xl text-slate-300 mb-3">storefront</span>
                            <p class="text-slate-400 font-medium">Seleccione una tienda para ver el personal asignado</p>
                        </div>`;
                    document.getElementById('assignmentCount').textContent = '(0)';
                    return;
                }

                const store = app.state.data.tiendas.find(t => t.id === app.state.selectedStoreId);
                const storeColor = store?.color_hex || '#f59e0b';
                const isLight = app.isLightColor(storeColor);
                const filter = app.state.viewFilter;
                const search = app.state.searchQuery;

                let staffCards = [];

                // Impulsadoras
                if (filter === 'all' || filter === 'impulsadoras') {
                    app.state.data.horarios.forEach(h => {
                        const person = app.state.data.impulsadoras.find(p => p.id === h.impulsadora_id);
                        if (person) {
                            const name = (person.nombre_completo || '').toLowerCase();
                            const matchesSearch = !search || name.includes(search);

                            staffCards.push({
                                type: 'impulsadora',
                                id: h.id,
                                personId: person.id,
                                name: person.nombre_completo || 'Sin nombre',
                                subtitle: person.Marca || 'Sin marca',
                                matchesSearch,
                                storeColor,
                                isLight
                            });
                        }
                    });
                }

                // Personal Interno
                if (filter === 'all' || filter === 'personal') {
                    app.state.data.personalHorarios.forEach(h => {
                        const person = app.state.data.personal.find(p => p.id === h.personal_id);
                        if (person) {
                            const name = (person.nombre_completo || '').toLowerCase();
                            const matchesSearch = !search || name.includes(search);

                            staffCards.push({
                                type: 'personal',
                                id: h.id,
                                personId: person.id,
                                name: person.nombre_completo || 'Sin nombre',
                                subtitle: 'Personal Interno',
                                matchesSearch,
                                storeColor: '#1e293b',
                                isLight: false
                            });
                        }
                    });
                }

                // Sort by name
                staffCards.sort((a, b) => a.name.localeCompare(b.name));

                // Count visible
                const visibleCount = staffCards.filter(c => c.matchesSearch).length;
                document.getElementById('assignmentCount').textContent = `(${visibleCount})`;

                if (staffCards.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16">
                            <span class="material-icons text-5xl text-slate-300 mb-3">person_off</span>
                            <p class="text-slate-400 font-medium">No hay personal asignado para esta fecha</p>
                        </div>`;
                    return;
                }

                let html = '<div class="p-4 space-y-3">';

                staffCards.forEach(card => {
                    const opacityClass = search && !card.matchesSearch ? 'opacity-25' : '';

                    html += `
                        <div class="staff-card bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-3 ${opacityClass}"
                             onclick="app.showCardActions('${card.type}', ${card.id}, '${card.name.replace(/'/g, "\\'")}')">
                            <!-- Badge -->
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-sm font-bold ${card.isLight ? 'text-slate-800' : 'text-white'}"
                                 style="background-color: ${card.storeColor}">
                                ${card.type === 'impulsadora' ? (store?.alias_tienda || 'T') : 'PI'}
                            </div>
                            
                            <!-- Info -->
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-slate-800 truncate">${card.name}</div>
                                <div class="text-xs text-slate-400 truncate">${card.subtitle}</div>
                            </div>

                            <!-- Type Badge -->
                            <div class="flex-shrink-0 px-2 py-1 rounded-full text-[10px] font-semibold ${card.type === 'impulsadora' ? 'bg-amber-100 text-amber-700' : 'bg-slate-200 text-slate-600'}">
                                ${card.type === 'impulsadora' ? 'Impulso' : 'Interno'}
                            </div>

                            <span class="material-icons text-slate-300 text-sm">chevron_right</span>
                        </div>`;
                });

                html += '</div>';
                container.innerHTML = html;
            },

            showCardActions: (type, horarioId, personName) => {
                const store = app.state.data.tiendas.find(t => t.id === app.state.selectedStoreId);
                const storeName = store?.nombre_display || 'Tienda';
                const dateStr = app.formatDate(app.state.selectedDate);

                Swal.fire({
                    title: personName,
                    html: `
                        <p class="text-slate-500 mb-4 text-sm">üìç ${storeName} ‚Ä¢ ${dateStr}</p>
                        <div class="space-y-3">
                            <button onclick="app.reportIncident('${type}', ${horarioId}, '${personName.replace(/'/g, "\\'")}', '${storeName.replace(/'/g, "\\'")}')" 
                                class="w-full py-3 px-4 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition-all">
                                <span class="material-icons text-base">report_problem</span> Reportar Incidencia
                            </button>
                        </div>
                    `,
                    showConfirmButton: false,
                    showCloseButton: true,
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
            },

            reportIncident: async (type, horarioId, personName, storeName) => {
                Swal.close();

                const dateStr = app.formatDate(app.state.selectedDate);

                const { value: formValues, isConfirmed } = await Swal.fire({
                    title: '‚ö†Ô∏è Reportar Incidencia',
                    html: `
                        <div class="text-left text-sm bg-slate-50 p-3 rounded-lg mb-4">
                            <p><strong>Personal:</strong> ${personName}</p>
                            <p><strong>Fecha:</strong> ${dateStr}</p>
                            <p><strong>Tienda:</strong> ${storeName}</p>
                        </div>
                        <select id="swal-tipo" class="w-full border rounded-lg px-3 py-2 mb-3">
                            <option value="FALTA INJUSTIFICADA">Falta Injustificada</option>
                            <option value="FALTA JUSTIFICADA">Falta Justificada</option>
                            <option value="IMPUNTUALIDAD">Impuntualidad</option>
                            <option value="PRESENTACI√ìN">Presentaci√≥n</option>
                            <option value="ACTITUD">Actitud</option>
                            <option value="QUEJA DE CLIENTE">Queja de Cliente</option>
                            <option value="OTROS">Otros</option>
                        </select>
                        <textarea id="swal-obs" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="Observaci√≥n..."></textarea>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar y Notificar',
                    confirmButtonColor: '#ef4444',
                    cancelButtonText: 'Cancelar',
                    preConfirm: () => ({
                        tipo: document.getElementById('swal-tipo').value,
                        obs: document.getElementById('swal-obs').value
                    })
                });

                if (isConfirmed) {
                    Swal.fire({ title: 'Guardando reporte...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                    try {
                        // Save to Tiendas_Faltas (only for impulsadoras for now)
                        if (type === 'impulsadora') {
                            const { error } = await db.from('Tiendas_Faltas').insert({
                                id_horario: horarioId,
                                asunto: formValues.tipo,
                                observacion: formValues.obs || null
                            });
                            if (error) throw error;
                        }

                        Swal.fire({
                            icon: 'success',
                            title: '¬°Reporte Guardado!',
                            text: 'La incidencia ha sido registrada.',
                            timer: 2500,
                            showConfirmButton: false
                        });

                    } catch (e) {
                        Swal.fire('Error', e.message, 'error');
                    }
                }
            },

            switchTab: (tab) => {
                switch (tab) {
                    case 'calendar':
                        window.location.href = 'admin-mobile.html';
                        break;
                    case 'stores':
                        // Already here
                        break;
                    case 'staff':
                        window.location.href = 'personal-mobile.html';
                        break;
                    case 'reports':
                        window.location.href = 'reportes-mobile.html';
                        break;
                    case 'profile':
                        app.showProfileMenu();
                        break;
                }
            },

            showProfileMenu: () => {
                const roleName = sessionStorage.getItem('staffPlannerRoleName') || 'Usuario';
                const email = app.state.user?.email || '';

                if (confirm(`${email}\nRol: ${roleName}\n\n¬øDeseas cerrar sesi√≥n?`)) {
                    app.logout();
                }
            },

            logout: () => {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>

</html>
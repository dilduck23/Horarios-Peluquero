<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Interno - ControlPeluquero</title>

    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .custom-scroll::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .cell-hover:hover {
            transform: scale(1.1);
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .empty-cell:hover {
            background-color: #dbeafe;
            cursor: pointer;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 20;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 30;
        }
    </style>
</head>

<body class="text-slate-800 min-h-screen">

    <!-- SUPABASE CLIENT -->
    <script>
        const SUPABASE_URL = 'https://cectqtufttubsepyiolr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Ow2zQpNDPsLA6on9VBWFgg_Q0_LAc1D';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>

    <!-- HEADER -->
    <header class="bg-slate-900 text-white shadow-lg">
        <div class="max-w-full mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="p-2 hover:bg-slate-700 rounded-lg transition-colors" title="Volver">
                    <span class="material-icons">arrow_back</span>
                </a>
                <div class="flex items-center gap-3">
                    <span class="material-icons text-green-400 text-3xl">groups</span>
                    <div>
                        <h1 class="text-xl font-bold">Personal Interno</h1>
                        <p class="text-xs text-slate-400">Calendario por Bodega</p>
                    </div>
                </div>
            </div>

            <!-- Month Navigation -->
            <div class="flex items-center gap-4">
                <div class="flex bg-slate-800 rounded-lg p-1">
                    <button onclick="app.changeMonth(-1)" class="p-2 hover:bg-slate-700 rounded transition">
                        <span class="material-icons text-sm">chevron_left</span>
                    </button>
                    <span class="px-4 text-sm font-semibold flex items-center" id="monthDisplay">...</span>
                    <button onclick="app.changeMonth(1)" class="p-2 hover:bg-slate-700 rounded transition">
                        <span class="material-icons text-sm">chevron_right</span>
                    </button>
                </div>

                <button id="btnAgregar" onclick="app.openAddPersonalModal()"
                    class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm">
                    <span class="material-icons text-base">person_add</span>
                    <span>Agregar Personal</span>
                </button>
            </div>
        </div>
    </header>

    <!-- LEGEND & SEARCH -->
    <div class="bg-white border-b border-slate-200 px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-6 text-xs">
                <span class="font-bold text-slate-500">LEYENDA:</span>
                <div class="flex items-center gap-2" id="legendContainer"></div>
                <div class="flex items-center gap-2 ml-4 border-l pl-4">
                    <div class="w-6 h-6 rounded bg-amber-400 flex items-center justify-center text-xl">üêÑ</div>
                    <span class="text-slate-600">Vacaciones</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded bg-purple-400 flex items-center justify-center text-xl">‚úã</div>
                    <span class="text-slate-600">Permiso</span>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="relative">
                <span class="material-icons absolute left-3 top-2 text-slate-400 text-base">search</span>
                <input type="text" id="searchInput" placeholder="Buscar por nombre..."
                    oninput="app.handleSearch(this.value)"
                    class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm w-64 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="p-6">
        <div class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
            <div class="overflow-auto custom-scroll max-h-[calc(100vh-220px)]">
                <table class="w-full border-collapse">
                    <thead class="bg-slate-100">
                        <tr id="calendarHeader">
                            <th class="sticky-col bg-slate-100 p-3 text-left border-r border-slate-200 min-w-[200px]">
                                Personal</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody">
                        <tr>
                            <td colspan="32" class="p-10 text-center text-slate-400">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- JAVASCRIPT -->
    <script>
        const app = {
            state: {
                currentDate: new Date(),
                monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                personal: [],
                tiendas: [],
                horarios: [],
                searchQuery: '',
                userRoleId: 0
            },

            init: async () => {
                // Check user role from sessionStorage (set by index.html)
                const roleId = parseInt(sessionStorage.getItem('staffPlannerRoleId') || '0');
                app.state.userRoleId = roleId;

                // Role 3 (PdV) cannot add or edit users - hide button
                if (roleId === 3) {
                    const btnAgregar = document.getElementById('btnAgregar');
                    if (btnAgregar) btnAgregar.style.display = 'none';
                }

                await app.loadData();
            },

            handleSearch: (query) => {
                app.state.searchQuery = query.trim();
                app.renderCalendar();
            },

            loadData: async () => {
                try {
                    // Load ALL personal (we'll show inactive ones differently)
                    const [personalRes, tiendasRes] = await Promise.all([
                        db.from('Tiendas_Personal').select('*').order('nombre_completo'),
                        db.from('Tiendas_Razonamiento').select('*')
                    ]);

                    console.log('Personal loaded:', personalRes.data?.length, personalRes.data);
                    console.log('Tiendas loaded:', tiendasRes.data?.length, tiendasRes.data);

                    if (personalRes.error) {
                        console.error('Error loading personal:', personalRes.error);
                    }

                    app.state.personal = personalRes.data || [];
                    app.state.tiendas = tiendasRes.data || [];

                    app.renderLegend();
                    await app.fetchHorarios();
                    app.renderCalendar();
                } catch (err) {
                    console.error('Error loading data:', err);
                    Swal.fire('Error', 'No se pudieron cargar los datos: ' + err.message, 'error');
                }
            },

            renderLegend: () => {
                const container = document.getElementById('legendContainer');
                let html = '';
                app.state.tiendas.forEach(t => {
                    html += `<div class="flex items-center gap-1">
                        <div class="w-5 h-5 rounded text-center text-white text-[10px] font-bold leading-5" 
                             style="background-color: ${t.color_hex || '#64748b'}">${t.alias_tienda || '?'}</div>
                        <span class="text-slate-500">${t.nombre_display}</span>
                    </div>`;
                });
                container.innerHTML = html;
            },

            fetchHorarios: async () => {
                const year = app.state.currentDate.getFullYear();
                const month = app.state.currentDate.getMonth();
                const firstDay = new Date(year, month, 1).toISOString().split('T')[0];
                const lastDay = new Date(year, month + 1, 0).toISOString().split('T')[0];

                const { data, error } = await db
                    .from('Tiendas_Personal_Horario')
                    .select('*')
                    .gte('fecha', firstDay)
                    .lte('fecha', lastDay);

                if (error) console.error('Error fetching horarios:', error);
                app.state.horarios = data || [];
            },

            changeMonth: async (delta) => {
                app.state.currentDate.setMonth(app.state.currentDate.getMonth() + delta);
                await app.fetchHorarios();
                app.renderCalendar();
            },

            renderCalendar: () => {
                const year = app.state.currentDate.getFullYear();
                const month = app.state.currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Update month display
                const monthName = app.state.currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                document.getElementById('monthDisplay').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

                // Render Header
                const days = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
                let headerHtml = '<th class="sticky-col bg-slate-100 p-3 text-left border-r border-slate-200 min-w-[200px]">Personal</th>';
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    const dayName = days[date.getDay()];
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const bgClass = isWeekend ? 'bg-slate-200' : 'bg-slate-100';
                    headerHtml += `<th class="min-w-[40px] border-r border-slate-200 p-2 text-center ${bgClass}">
                        <div class="text-lg font-bold leading-none text-slate-700">${i}</div>
                        <div class="text-[9px] font-medium text-slate-500">${dayName}</div>
                    </th>`;
                }
                document.getElementById('calendarHeader').innerHTML = headerHtml;

                // Filter by search query
                let filteredPersonal = app.state.personal;
                if (app.state.searchQuery) {
                    const query = app.state.searchQuery.toLowerCase();
                    filteredPersonal = app.state.personal.filter(p =>
                        p.nombre_completo.toLowerCase().includes(query) ||
                        (p.idVendedor && p.idVendedor.toLowerCase().includes(query))
                    );
                }

                // Group personal by bodega
                const byBodega = {};
                filteredPersonal.forEach(p => {
                    // Handle both possible column names (case sensitivity)
                    const bodegaId = p.idBodega || p.idbodega || 0;
                    if (!byBodega[bodegaId]) byBodega[bodegaId] = [];
                    byBodega[bodegaId].push(p);
                });

                console.log('Grouped by bodega:', byBodega);

                // Render Body
                let bodyHtml = '';
                Object.keys(byBodega).sort((a, b) => a - b).forEach(bodegaId => {
                    const tienda = app.state.tiendas.find(t => t.id === parseInt(bodegaId));
                    const bodegaName = tienda ? tienda.nombre_display : 'Sin Bodega Asignada';
                    const bodegaColor = tienda?.color_hex || '#64748b';

                    // Bodega Header Row
                    bodyHtml += `<tr class="bg-slate-800">
                        <td colspan="${1 + daysInMonth}" class="p-3 text-white font-bold text-sm sticky-col bg-slate-800">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded" style="background-color: ${bodegaColor}"></div>
                                üè™ ${bodegaName} (${byBodega[bodegaId].length} personas)
                            </div>
                        </td>
                    </tr>`;

                    // Personal rows
                    byBodega[bodegaId].forEach(person => {
                        const personCode = person.idVendedor || person.idvendedor || '';
                        bodyHtml += `<tr class="hover:bg-slate-50">`;
                        bodyHtml += `<td class="sticky-col bg-white p-2 border-r border-slate-200 cursor-pointer group">
                            <div class="flex items-center gap-2">
                                <div class="flex-1" onclick="app.openPersonProfile(${person.id})">
                                    <div class="text-sm font-medium text-slate-800 group-hover:text-blue-600">${person.nombre_completo}</div>
                                    ${personCode ? `<div class="text-xs text-slate-400">${personCode}</div>` : ''}
                                </div>
                                <button onclick="event.stopPropagation(); app.autoFillMonth(${person.id})" 
                                    class="p-1 hover:bg-amber-100 rounded transition-colors" title="Llenar mes con bodega asignada">
                                    <span class="material-icons text-amber-500 text-sm">auto_awesome</span>
                                </button>
                                <span class="material-icons text-slate-300 group-hover:text-blue-500 text-sm" onclick="app.openPersonProfile(${person.id})">edit</span>
                            </div>
                        </td>`;

                        // Days
                        for (let d = 1; d <= daysInMonth; d++) {
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            const horario = app.state.horarios.find(h => h.personal_id === person.id && h.fecha === dateStr);
                            const date = new Date(year, month, d);
                            const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                            if (horario) {
                                let cellContent = '';
                                let cellStyle = '';

                                if (horario.tipo === 'VACACIONES') {
                                    cellContent = 'üêÑ';
                                    cellStyle = 'background-color: #fbbf24;';
                                } else if (horario.tipo === 'PERMISO') {
                                    cellContent = '‚úã';
                                    cellStyle = 'background-color: #a855f7; color: white;';
                                } else {
                                    // Normal work - show store alias with color
                                    const tiendaTrabajo = app.state.tiendas.find(t => t.id === horario.tienda_id);
                                    cellContent = tiendaTrabajo?.alias_tienda || '?';
                                    cellStyle = `background-color: ${tiendaTrabajo?.color_hex || '#22c55e'}; color: white;`;
                                }

                                bodyHtml += `<td class="p-1 border-r border-slate-100 text-center">
                                    <div class="w-full h-7 rounded flex items-center justify-center text-[10px] font-bold cell-hover transition-all"
                                         style="${cellStyle}"
                                         onclick="app.handleCellClick(${person.id}, '${dateStr}', ${horario.id})">
                                        ${cellContent}
                                    </div>
                                </td>`;
                            } else {
                                const emptyBg = isWeekend ? 'bg-slate-50' : '';
                                bodyHtml += `<td class="p-1 border-r border-slate-100 text-center ${emptyBg}">
                                    <div class="w-full h-7 rounded border border-dashed border-slate-200 empty-cell transition-all"
                                         onclick="app.handleCellClick(${person.id}, '${dateStr}', null)">
                                    </div>
                                </td>`;
                            }
                        }
                        bodyHtml += '</tr>';
                    });
                });

                if (app.state.personal.length === 0) {
                    bodyHtml = `<tr><td colspan="${1 + daysInMonth}" class="p-10 text-center text-slate-400">
                        No hay personal registrado. <button onclick="app.openAddPersonalModal()" class="text-blue-500 underline">Agregar primero</button>
                    </td></tr>`;
                }

                document.getElementById('calendarBody').innerHTML = bodyHtml;
            },

            handleCellClick: (personalId, dateStr, horarioId) => {
                const person = app.state.personal.find(p => p.id === personalId);
                const personBodega = person.idBodega || person.idbodega;

                // Sort tiendas so person's bodega appears first
                const sortedTiendas = [...app.state.tiendas].sort((a, b) => {
                    if (a.id === personBodega) return -1;
                    if (b.id === personBodega) return 1;
                    return 0;
                });

                const tiendaOptions = sortedTiendas.map(t =>
                    `<option value="${t.id}" ${t.id === personBodega ? 'selected' : ''}>${t.nombre_display}</option>`
                ).join('');

                const friendlyDate = new Date(dateStr + 'T00:00:00').toLocaleDateString('es-ES', {
                    weekday: 'long', day: 'numeric', month: 'long'
                });

                if (horarioId) {
                    // EDIT MODE
                    const horario = app.state.horarios.find(h => h.id === horarioId);
                    const isSpecial = horario.tipo === 'VACACIONES' || horario.tipo === 'PERMISO';

                    Swal.fire({
                        title: 'Editar Asignaci√≥n',
                        html: `
                            <div class="text-left text-sm mb-4">
                                <p><strong>Personal:</strong> ${person.nombre_completo}</p>
                                <p><strong>Fecha:</strong> ${friendlyDate}</p>
                            </div>
                            <div class="flex gap-2 mb-4">
                                <button type="button" id="btn-trabajo" onclick="app.setTipo('TRABAJO')" 
                                    class="flex-1 p-2 rounded-lg border-2 ${!isSpecial ? 'border-green-500 bg-green-50' : 'border-slate-200'} transition-all">
                                    üè™ Tienda
                                </button>
                                <button type="button" id="btn-vacaciones" onclick="app.setTipo('VACACIONES')"
                                    class="flex-1 p-2 rounded-lg border-2 ${horario.tipo === 'VACACIONES' ? 'border-amber-500 bg-amber-50' : 'border-slate-200'} transition-all">
                                    üêÑ Vacaciones
                                </button>
                                <button type="button" id="btn-permiso" onclick="app.setTipo('PERMISO')"
                                    class="flex-1 p-2 rounded-lg border-2 ${horario.tipo === 'PERMISO' ? 'border-purple-500 bg-purple-50' : 'border-slate-200'} transition-all">
                                    ‚úã Permiso
                                </button>
                            </div>
                            <div id="tienda-select-container" style="display: ${!isSpecial ? 'block' : 'none'}">
                                <label class="block text-left text-xs font-bold text-slate-500 mb-1">Asignar a Tienda:</label>
                                <select id="swal-tienda" class="w-full p-2 border rounded-lg mb-4">
                                    ${tiendaOptions}
                                </select>
                            </div>
                            <input type="hidden" id="swal-tipo" value="${horario.tipo}">
                        `,
                        showDenyButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'üíæ Guardar',
                        denyButtonText: 'üóëÔ∏è Eliminar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#2563eb',
                        denyButtonColor: '#ef4444',
                        didOpen: () => {
                            if (horario.tienda_id) {
                                document.getElementById('swal-tienda').value = horario.tienda_id;
                            }
                        },
                        preConfirm: async () => {
                            const tipo = document.getElementById('swal-tipo').value;
                            const tiendaId = tipo === 'TRABAJO' ? parseInt(document.getElementById('swal-tienda').value) : null;

                            const { error } = await db.from('Tiendas_Personal_Horario')
                                .update({ tipo, tienda_id: tiendaId })
                                .eq('id', horarioId);

                            if (error) {
                                Swal.showValidationMessage(error.message);
                                return false;
                            }
                            return true;
                        },
                        preDeny: async () => {
                            const { error } = await db.from('Tiendas_Personal_Horario').delete().eq('id', horarioId);
                            if (error) {
                                Swal.fire('Error', error.message, 'error');
                                return false;
                            }
                            return true;
                        }
                    }).then(async (result) => {
                        if (result.isConfirmed || result.isDenied) {
                            await app.fetchHorarios();
                            app.renderCalendar();
                        }
                    });

                } else {
                    // ADD MODE
                    Swal.fire({
                        title: 'Nueva Asignaci√≥n',
                        html: `
                            <div class="text-left text-sm mb-4">
                                <p><strong>Personal:</strong> ${person.nombre_completo}</p>
                                <p><strong>Fecha:</strong> ${friendlyDate}</p>
                            </div>
                            <div class="flex gap-2 mb-4">
                                <button type="button" id="btn-trabajo" onclick="app.setTipo('TRABAJO')" 
                                    class="flex-1 p-2 rounded-lg border-2 border-green-500 bg-green-50 transition-all">
                                    üè™ Tienda
                                </button>
                                <button type="button" id="btn-vacaciones" onclick="app.setTipo('VACACIONES')"
                                    class="flex-1 p-2 rounded-lg border-2 border-slate-200 transition-all">
                                    üêÑ Vacaciones
                                </button>
                                <button type="button" id="btn-permiso" onclick="app.setTipo('PERMISO')"
                                    class="flex-1 p-2 rounded-lg border-2 border-slate-200 transition-all">
                                    ‚úã Permiso
                                </button>
                            </div>
                            <div id="tienda-select-container">
                                <label class="block text-left text-xs font-bold text-slate-500 mb-1">Asignar a Tienda:</label>
                                <select id="swal-tienda" class="w-full p-2 border rounded-lg mb-4">
                                    ${tiendaOptions}
                                </select>
                            </div>
                            <input type="hidden" id="swal-tipo" value="TRABAJO">
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'üíæ Guardar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#2563eb',
                        preConfirm: async () => {
                            const tipo = document.getElementById('swal-tipo').value;
                            const tiendaId = tipo === 'TRABAJO' ? parseInt(document.getElementById('swal-tienda').value) : null;

                            if (tipo === 'TRABAJO' && !tiendaId) {
                                Swal.showValidationMessage('Selecciona una tienda');
                                return false;
                            }

                            const { error } = await db.from('Tiendas_Personal_Horario').insert({
                                personal_id: personalId,
                                fecha: dateStr,
                                tipo: tipo,
                                tienda_id: tiendaId
                            });

                            if (error) {
                                Swal.showValidationMessage(error.message);
                                return false;
                            }
                            return true;
                        }
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            await app.fetchHorarios();
                            app.renderCalendar();
                        }
                    });
                }
            },

            setTipo: (tipo) => {
                document.getElementById('swal-tipo').value = tipo;

                // Update button styles
                document.getElementById('btn-trabajo').className =
                    `flex-1 p-2 rounded-lg border-2 ${tipo === 'TRABAJO' ? 'border-green-500 bg-green-50' : 'border-slate-200'} transition-all`;
                document.getElementById('btn-vacaciones').className =
                    `flex-1 p-2 rounded-lg border-2 ${tipo === 'VACACIONES' ? 'border-amber-500 bg-amber-50' : 'border-slate-200'} transition-all`;
                document.getElementById('btn-permiso').className =
                    `flex-1 p-2 rounded-lg border-2 ${tipo === 'PERMISO' ? 'border-purple-500 bg-purple-50' : 'border-slate-200'} transition-all`;

                // Show/hide tienda selector
                document.getElementById('tienda-select-container').style.display = tipo === 'TRABAJO' ? 'block' : 'none';
            },

            openAddPersonalModal: () => {
                const tiendaOptions = app.state.tiendas.map(t => `<option value="${t.id}">${t.nombre_display}</option>`).join('');

                Swal.fire({
                    title: '‚ûï Agregar Personal Interno',
                    html: `
                        <div class="text-left space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">C√≥digo *</label>
                                    <input type="text" id="add-idvendedor" class="w-full p-2 border rounded-lg text-sm" placeholder="V001" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Nombre Completo *</label>
                                    <input type="text" id="add-nombre" class="w-full p-2 border rounded-lg text-sm" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Bodega Asignada</label>
                                    <select id="add-bodega" class="w-full p-2 border rounded-lg text-sm">
                                        <option value="">Sin asignar</option>
                                        ${tiendaOptions}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">WhatsApp</label>
                                <input type="tel" id="add-whatsapp" class="w-full p-2 border rounded-lg text-sm" placeholder="+593...">
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'üíæ Guardar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#16a34a',
                    preConfirm: () => {
                        const idVendedor = document.getElementById('add-idvendedor').value.trim();
                        const nombre = document.getElementById('add-nombre').value.trim();

                        if (!idVendedor || !nombre) {
                            Swal.showValidationMessage('C√≥digo y Nombre son obligatorios');
                            return false;
                        }

                        const bodegaVal = document.getElementById('add-bodega').value;
                        return {
                            idvendedor: idVendedor,
                            nombre_completo: nombre,
                            idbodega: bodegaVal ? parseInt(bodegaVal) : null,
                            whatsapp: document.getElementById('add-whatsapp').value || null,
                            habilitado: true
                        };
                    }
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        Swal.fire({ title: 'Generando PIN y Guardando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                        // Generate unique PIN across both tables
                        let pin = null;
                        let attempts = 0;
                        while (!pin && attempts < 100) {
                            const candidate = String(Math.floor(1000 + Math.random() * 9000));

                            const { data: impCheck } = await db.from('Tiendas_Impulsadoras').select('id').eq('pin', candidate).single();
                            const { data: perCheck } = await db.from('Tiendas_Personal').select('id').eq('pin', candidate).single();

                            if (!impCheck && !perCheck) {
                                pin = candidate;
                            }
                            attempts++;
                        }

                        if (!pin) {
                            Swal.fire('Error', 'No se pudo generar un PIN √∫nico. Intenta de nuevo.', 'error');
                            return;
                        }

                        result.value.pin = pin;

                        const { data, error } = await db.from('Tiendas_Personal').insert(result.value).select();

                        if (error) {
                            Swal.fire('Error', error.message, 'error');
                        } else {
                            if (data && data[0]) app.state.personal.push(data[0]);
                            Swal.fire({
                                icon: 'success',
                                title: '¬°Agregado!',
                                html: `<p>PIN generado: <span class="font-mono font-bold text-2xl">${pin}</span></p>`,
                                timer: 3000,
                                showConfirmButton: true
                            });
                            app.renderCalendar();
                        }
                    }
                });
            },

            // Auto-fill: Insert horarios for all missing dates of the month with the person's assigned bodega
            autoFillMonth: async (personalId) => {
                const person = app.state.personal.find(p => p.id === personalId);
                if (!person) return;

                const bodegaId = person.idBodega || person.idbodega;
                if (!bodegaId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sin bodega asignada',
                        text: 'Este personal no tiene una bodega/tienda vinculada. Asigna una primero.',
                        confirmButtonColor: '#f59e0b'
                    });
                    return;
                }

                // Get tienda name for confirmation
                const tienda = app.state.tiendas.find(t => t.id === bodegaId);
                const tiendaName = tienda?.nombre_display || tienda?.alias_tienda || 'Tienda';

                const confirm = await Swal.fire({
                    title: 'ü™Ñ Llenado Autom√°tico',
                    html: `<p>Se asignar√°n todas las fechas faltantes de <strong>${app.state.monthNames[app.state.currentDate.getMonth()]} ${app.state.currentDate.getFullYear()}</strong> a:</p>
                           <p class="mt-2 text-lg font-bold text-blue-600">${tiendaName}</p>
                           <p class="mt-3 text-sm text-slate-500">Para: ${person.nombre_completo}</p>`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, llenar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#f59e0b'
                });

                if (!confirm.isConfirmed) return;

                Swal.fire({ title: 'Llenando fechas...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    const year = app.state.currentDate.getFullYear();
                    const month = app.state.currentDate.getMonth();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    // Get existing horarios for this person in this month
                    const existingDates = app.state.horarios
                        .filter(h => h.personal_id === personalId)
                        .map(h => h.fecha);

                    // Find missing dates
                    const insertData = [];
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        if (!existingDates.includes(dateStr)) {
                            insertData.push({
                                personal_id: personalId,
                                fecha: dateStr,
                                tienda_id: bodegaId
                            });
                        }
                    }

                    if (insertData.length === 0) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Ya est√° completo',
                            text: 'Todas las fechas del mes ya tienen asignaci√≥n.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        return;
                    }

                    // Insert all at once
                    const { error } = await db.from('Tiendas_Personal_Horario').insert(insertData);

                    if (error) throw error;

                    // Refresh
                    await app.fetchHorarios();
                    app.renderCalendar();

                    Swal.fire({
                        icon: 'success',
                        title: '¬°Listo!',
                        text: `Se asignaron ${insertData.length} d√≠as a ${tiendaName}`,
                        timer: 2000,
                        showConfirmButton: false
                    });

                } catch (err) {
                    console.error('Auto-fill error:', err);
                    Swal.fire('Error', err.message, 'error');
                }
            },

            openPersonProfile: (personalId) => {
                // Role 3 (PdV) cannot edit users
                if (app.state.userRoleId === 3) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Solo lectura',
                        text: 'No tienes permisos para editar usuarios.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    return;
                }

                const person = app.state.personal.find(p => p.id === personalId);
                if (!person) return;

                const tiendaOptions = app.state.tiendas.map(t =>
                    `<option value="${t.id}" ${(person.idBodega || person.idbodega) === t.id ? 'selected' : ''}>${t.nombre_display}</option>`
                ).join('');

                const personCode = person.idVendedor || person.idvendedor || '';

                Swal.fire({
                    title: 'üë§ Editar Personal',
                    html: `
                        <div class="text-left space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">C√≥digo</label>
                                    <input type="text" id="edit-idvendedor" value="${personCode}" class="w-full p-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Nombre Completo *</label>
                                    <input type="text" id="edit-nombre" value="${person.nombre_completo}" class="w-full p-2 border rounded-lg text-sm" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Bodega Asignada</label>
                                    <select id="edit-bodega" class="w-full p-2 border rounded-lg text-sm">
                                        <option value="">Sin asignar</option>
                                        ${tiendaOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">WhatsApp</label>
                                    <input type="tel" id="edit-whatsapp" value="${person.Whatsapp || person.whatsapp || ''}" class="w-full p-2 border rounded-lg text-sm">
                                </div>
                            </div>
                            <div class="flex items-center gap-2 pt-2 border-t">
                                <input type="checkbox" id="edit-habilitado" ${person.habilitado !== false ? 'checked' : ''} class="w-4 h-4">
                                <label for="edit-habilitado" class="text-sm font-medium">Habilitado</label>
                            </div>
                        </div>
                    `,
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'üíæ Guardar',
                    denyButtonText: 'üóëÔ∏è Eliminar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#2563eb',
                    denyButtonColor: '#ef4444',
                    preConfirm: async () => {
                        const nombre = document.getElementById('edit-nombre').value.trim();
                        if (!nombre) {
                            Swal.showValidationMessage('El nombre es obligatorio');
                            return false;
                        }

                        const bodegaVal = document.getElementById('edit-bodega').value;
                        const updateData = {
                            idvendedor: document.getElementById('edit-idvendedor').value.trim() || null,
                            nombre_completo: nombre,
                            idbodega: bodegaVal ? parseInt(bodegaVal) : null,
                            whatsapp: document.getElementById('edit-whatsapp').value || null,
                            habilitado: document.getElementById('edit-habilitado').checked
                        };

                        const { error } = await db.from('Tiendas_Personal')
                            .update(updateData)
                            .eq('id', personalId);

                        if (error) {
                            Swal.showValidationMessage(error.message);
                            return false;
                        }

                        // Update local state
                        Object.assign(person, updateData);
                        return true;
                    },
                    preDeny: async () => {
                        const confirmDelete = await Swal.fire({
                            title: '¬øEliminar Personal?',
                            text: `¬øSeguro que deseas eliminar a ${person.nombre_completo}? Esta acci√≥n no se puede deshacer.`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'S√≠, eliminar',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: '#ef4444'
                        });

                        if (confirmDelete.isConfirmed) {
                            const { error } = await db.from('Tiendas_Personal').delete().eq('id', personalId);
                            if (error) {
                                Swal.fire('Error', error.message, 'error');
                                return false;
                            }
                            // Remove from local state
                            app.state.personal = app.state.personal.filter(p => p.id !== personalId);
                            return true;
                        }
                        return false;
                    }
                }).then((result) => {
                    if (result.isConfirmed || result.isDenied) {
                        app.renderCalendar();
                    }
                });
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', app.init);
    </script>

</body>

</html>